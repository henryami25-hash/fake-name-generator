<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="monetag" content="5b6d9505cca1138da217213bf17710b7">
  
  <title>Fake Name Generator</title>

  <!-- Firebase CDN (compat, mobile safe) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    :root{
      --bg1:#0b1220; --bg2:#0a2a5a;
      --card: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text:#eaf0ff;
      --muted: rgba(255,255,255,.75);
      --btn:#2b6cff;
      --btn2: rgba(255,255,255,.10);
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
      min-height:100vh;
      background: radial-gradient(1200px 700px at 20% 10%, #173b8f 0%, rgba(23,59,143,0) 55%),
                  radial-gradient(900px 600px at 80% 30%, #0bb3ff33 0%, rgba(11,179,255,0) 60%),
                  linear-gradient(160deg, var(--bg1), var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{width:min(520px, 100%)}
    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .top{
      padding:18px 18px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-size:13px;
      text-decoration:none;
      color:var(--text);
      white-space:nowrap;
    }
    .pill svg{width:16px;height:16px;opacity:.95}
    .notice{
      display:none;
      padding:10px 14px;
      background: rgba(255, 215, 0, .10);
      border-bottom:1px solid rgba(255,255,255,.10);
      font-size:13px;
      color: rgba(255,255,255,.92);
    }
    .content{padding:16px 18px 18px}
    label{display:block;font-size:12px; color: var(--muted); margin-bottom:6px}
    select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.14);
      color: var(--text);
      outline:none;
    }
    .row{display:flex; gap:10px; margin-top:12px}
    .row > *{flex:1}
    .btn{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:0;
      background: var(--btn);
      color:white;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 10px 18px rgba(43,108,255,.25);
    }
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn2{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: var(--btn2);
      color: var(--text);
      font-weight:700;
      cursor:pointer;
    }
    .out{
      margin-top:14px;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      font-size:18px;
      font-weight:800;
      letter-spacing:.2px;
      text-align:center;
      user-select:text;
      cursor:pointer;
    }
    .status{
      margin-top:12px;
      font-size:13px;
      color: rgba(255,255,255,.85);
      line-height:1.4;
      min-height:18px;
    }
    .sub{
      margin-top:10px;
      font-size:12px;
      color: rgba(255,255,255,.70);
      line-height:1.5;
    }
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.75);
      border:1px solid rgba(255,255,255,.16);
      color:#fff;
      padding:10px 14px;
      border-radius:999px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:.25s;
      z-index:9999;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-4px)}
    /* Center text perfectly inside Ad-Free button */
#adFreeBtn{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  text-align:center;
  line-height:1.3;
  padding:14px 16px;
}
    /* ONLY Join Telegram text color */
#noticeBar a{
  color:#4da3ff !important;   /* blue */
  font-weight:800;
  text-decoration:none;
}

#noticeBar a:hover{
  text-decoration:underline;
}
/* ===== Dice logo remove ===== */
.logo{
  display:none !important;
}

/* ===== Title single line: Fake Name Generator ===== */
.title{
  display:flex;
  align-items:center;
}

/* main title text ‚Äî SMALLER */
.title > div > div:first-child{
  font-size:18px !important;   /* ‡¶Ü‡¶ó‡ßá 30px ‡¶õ‡¶ø‡¶≤ */
  font-weight:800 !important;
  line-height:1.2 !important;
  white-space:nowrap !important;
  margin:0 !important;
}

/* subtitle ‚Äî smaller */
.title > div > div:nth-child(2){
  font-size:11px !important;   /* ‡¶Ü‡¶ó‡ßá 14px ‡¶õ‡¶ø‡¶≤ */
  opacity:.6 !important;
  margin-top:4px !important;
}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="title">
          <div class="logo">üé≤</div>
          <div>
            <div style="font-size:16px">Fake Name Generator</div>
            <div style="font-size:12px; opacity:.75; font-weight:600">Random ‚Ä¢ No Repeat</div>
          </div>
        </div>

        <a class="pill" id="tgPill" href="#" target="_blank" rel="noopener" style="display:none;">
          <!-- Telegram icon -->
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path fill="currentColor" d="M21.98 4.47c.17-.73-.63-1.28-1.3-1.01L2.76 10.5c-.74.28-.7 1.35.06 1.58l4.62 1.43 1.78 5.62c.23.72 1.17.82 1.54.16l2.62-4.64 5.03 3.72c.61.45 1.5.11 1.64-.66l2.55-13.24Zm-3.9 2.82-8.2 7.5c-.28.25-.46.59-.52.96l-.5 3.18-1.1-3.48c-.12-.38-.42-.68-.8-.8l-3.5-1.08 15.2-5.83-0.58 0.55Z"/>
          </svg>
          <span>Telegram</span>
        </a>
        <a class="pill" id="tgLinkTop" href="#" target="_blank" rel="noopener" style="display:none;"></a>
      </div>

      <div class="notice" id="noticeBar"></div>

      <div class="content">
        <label>Country</label>
        <select id="countrySelect"><option value="">Loading...</option></select>

        <div class="row">
          <div>
            <label>Gender</label>
            <select id="genderSelect">
              <option value="male">Male</option>
              <option value="female">Female</option>
            </select>
          </div>
          <div>
            <label>&nbsp;</label>
            <button class="btn" id="genBtn">Generate</button>
          </div>
        </div>

        <div class="out" id="nameBox" title="Tap to copy">Loading‚Ä¶</div>

        <div class="row" style="margin-top:10px">
          <button class="btn2" id="resetBtn">Reset (this country+gender)</button>
          <button class="btn2" id="refreshBtn">Refresh data</button>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn2" id="adFreeBtn">üéÅ Watch 10 Ads ‚Üí 24h Ad-Free</button>
        </div>
        <div class="status" id="adFreeStatus" style="margin-top:6px;"></div>

        <div class="status" id="statusLine"></div>

        <div class="sub">
          ‚úÖ Smart Random: ‡¶®‡¶æ‡¶Æ‡¶ó‡ßÅ‡¶≤‡ßã shuffle ‡¶π‡ßü‡ßá random order ‡¶è ‡¶Ü‡¶∏‡ßá, list ‡¶∂‡ßá‡¶∑ ‡¶π‡¶≤‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® shuffle ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶π‡ßü‡•§<br>
          üìã ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡¶≤‡ßá auto-copy ‡¶π‡¶¨‡ßá‡•§
        </div>
      </div>
    </div>
  </div>

  <!-- Adblock / DNS Lock -->
  <div id="adblockLock" style="
    position:fixed; inset:0; background:#000; color:#fff;
    display:none; z-index:99999; padding:24px;
    align-items:center; justify-content:center; text-align:center;">
    <div style="max-width:440px">
      <div style="font-size:22px; font-weight:800; margin-bottom:10px;">‚ö†Ô∏è Ad Block / DNS Detected</div>
      <div data-lock-msg style="opacity:.92; line-height:1.55; margin-bottom:16px;">
        DNS / Ad blocker ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§<br>
        ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá <b>Private DNS / Adblock OFF</b> ‡¶ï‡¶∞‡ßÅ‡¶®‡•§
      </div>
      <button class="btn" onclick="location.reload()" style="width:100%;">OFF ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø ‚Äî Reload</button>
      <div style="margin-top:12px; font-size:12px; opacity:.75;">
        (OFF ‡¶®‡¶æ ‡¶ï‡¶∞‡¶≤‡ßá Generate ‡¶¨‡¶®‡ßç‡¶ß ‡¶•‡¶æ‡¶ï‡¶¨‡ßá)
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ========= Firebase Config ========= */
const firebaseConfig = {
  apiKey: "AIzaSyCZ08SgQo36dVouHYVatQjOPBjR7FBuiTM",
  authDomain: "fake-name-generator-445ef.firebaseapp.com",
  projectId: "fake-name-generator-445ef",
  storageBucket: "fake-name-generator-445ef.appspot.com",
  messagingSenderId: "173185143834",
  appId: "1:173185143834:web:e39cfc5ca34abfc458eda3"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const $ = (id)=>document.getElementById(id);

/* ========= Ads / Gate (All-in-one) ========= */
const GEN_INTERVAL = 5;              // every 5 generate => interstitial
const DAILY_AD_CAP = 8;              // max interstitials per user per 24h
const LS_GEN = "fng_global_gen_v1";  // global generate counter (never resets on country change)
const LS_DAY = "fng_day_v1";
const LS_ADS = "fng_ads_today_v1";
const LS_ADFREE_UNTIL = "fng_adfree_until_v1";
const LS_ADFREE_PROGRESS = "fng_adfree_progress_v1";

let APP_LOCKED = false;

// Remote toggles (admin controlled via Firestore settings/ads)
let ADS_ENABLED = true;
let INTERSTITIAL_ENABLED = true;
let ADFREE_OPTION_ENABLED = true;
let DNS_HARD_LOCK_ENABLED = true;
// ===== REWARD ADS : FULL SAFE CONFIG =====
const REWARD_ADS_REQUIRED = 10;      // ‡¶ï‡ßü‡¶ü‡¶æ ad ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá
const REWARD_COOLDOWN = 25000;       // 25 seconds gap (BEST for BD)
const REWARD_ADFREE_HOURS = 24;      // 24h Ad-Free

let lastRewardAdTime = 0;
// Monetag / ad network hook (replace inside this function only)
// === Monetag Direct Link config ===
const MONETAG_AD_LINK = "https://otieu.com/4/10457847";
const AD_COOLDOWN = 15000; // 15 sec
let __adBusy = false;

function showInterstitialSafe(){
  if(__adBusy) return;

  __adBusy = true;
  window.open(MONETAG_AD_LINK, "_blank");

  setTimeout(()=>{
    __adBusy = false;
  }, AD_COOLDOWN);
}

function todayKey(){ return new Date().toDateString(); }

function ensureDay(){
  const t = todayKey();
  if(localStorage.getItem(LS_DAY) !== t){
    localStorage.setItem(LS_DAY, t);
    localStorage.setItem(LS_ADS, "0");
  }
}
function getCounts(){
  ensureDay();
  return {
    gen: parseInt(localStorage.getItem(LS_GEN) || "0", 10),
    ads: parseInt(localStorage.getItem(LS_ADS) || "0", 10)
  };
}
function setGen(v){ localStorage.setItem(LS_GEN, String(v)); }
function setAds(v){ localStorage.setItem(LS_ADS, String(v)); }

function isAdFreeActive(){
  const until = parseInt(localStorage.getItem(LS_ADFREE_UNTIL) || "0", 10);
  return Date.now() < until;
}
function adFreeProgress(){
  return parseInt(localStorage.getItem(LS_ADFREE_PROGRESS) || "0", 10);
}

function updateAdFreeUI(){
  const el = $("adFreeStatus");
  const btn = $("adFreeBtn");
  if(!el || !btn) return;

  if(!ADFREE_OPTION_ENABLED){
    btn.style.display = "none";
    el.style.display = "none";
    return;
  }
  btn.style.display = "inline-flex";
  el.style.display = "block";

  if(isAdFreeActive()){
    const mins = Math.max(0, Math.ceil((parseInt(localStorage.getItem(LS_ADFREE_UNTIL) || "0", 10) - Date.now())/60000));
    el.textContent = `‚úÖ Ad-Free active ‚Ä¢ ${mins} min left`;
  }else{
    
    const left = Math.max(0, REWARD_ADS_REQUIRED - adFreeProgress());
el.textContent = `Watch ${left} ads (25s gap) ‚Üí unlock 24h Ad-Free`;
  }
}

function lockApp(reasonText){
  APP_LOCKED = true;

  const p = $("adblockLock");
  if(p){
    if(reasonText){
      const msg = p.querySelector("[data-lock-msg]");
      if(msg) msg.innerHTML = reasonText;
    }
    p.style.display = "flex";
  }

  // Disable main actions (extra hard)
  try{ $("genBtn").disabled = true; }catch{}
  try{ $("adFreeBtn").disabled = true; }catch{}
  try{ $("resetBtn").disabled = true; }catch{}
  try{ $("refreshBtn").disabled = true; }catch{}
}

function unlockApp(){
  APP_LOCKED = false;

  const p = $("adblockLock");
  if(p) p.style.display = "none";

  // Enable again
  try{ $("genBtn").disabled = false; }catch{}
  try{ $("adFreeBtn").disabled = false; }catch{}
  try{ $("resetBtn").disabled = false; }catch{}
  try{ $("refreshBtn").disabled = false; }catch{}
}
// Mixed adblock detection (to reduce false positives)
function detectAdblock(){
  return new Promise((resolve)=>{
    // 1) Bait element
    const bait = document.createElement("div");
    bait.className = "adsbox ad ads banner ad-banner";
    bait.style.cssText = "height:10px; position:absolute; left:-9999px; top:-9999px;";
    document.body.appendChild(bait);

    // 2) Script probe (often blocked by DNS/adblock)
    const s = document.createElement("script");
    s.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js";
    s.async = true;

    let done = false;
    const finish = (blocked)=>{
      if(done) return;
      done = true;
      try{ document.body.removeChild(bait); }catch{}
      resolve(!!blocked);
    };

    s.onload = ()=>setTimeout(()=>{
      const baitBlocked = (bait.offsetHeight === 0);
      finish(baitBlocked);
    }, 50);

    s.onerror = ()=>finish(true);

    document.head.appendChild(s);

    setTimeout(()=>{
      const baitBlocked = (bait.offsetHeight === 0);
      finish(baitBlocked);
    }, 1800);
  });
}

async function setupAdblockGate(){
  // üî• Always reset lock first
  unlockApp();

  // Admin OFF ‡¶ï‡¶∞‡¶≤‡ßá ‡¶è‡¶ï‡¶¶‡¶Æ skip
  if(!DNS_HARD_LOCK_ENABLED){
    return;
  }

  try{
    const blocked = await detectAdblock();

    if(blocked){
      lockApp(`DNS / Ad blocker ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§<br>
               ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá <b>Private DNS / Adblock OFF</b> ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`);
    }
  }catch{
    unlockApp();
  }
}

  try{
    const blocked = await detectAdblock();

    if(blocked){
      lockApp(`DNS / Ad blocker ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ‡•§<br>
              ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá <b>Private DNS / Adblock OFF</b> ‡¶ï‡¶∞‡ßÅ‡¶®‡•§`);
    }else{
      unlockApp();
    }
  }catch{
    // detection error => do not lock (avoid false lock)
    unlockApp();
  }
}
// Minimal server-side sync (analytics + abuse control)
async function syncUserCounters(genCount, adsShown){
  const u = auth.currentUser;
  if(!u) return;
  await db.collection("users").doc(u.uid).set({
    genCount: genCount,
    adsShownToday: adsShown,
    lastSeenAt: Date.now()
  }, { merge:true });
}

// Remote settings listener: settings/ads
function startAdsSettingsListener(){
  db.collection("settings").doc("ads").onSnapshot((doc)=>{
    if(!doc.exists) return;
    const d = doc.data() || {};
    ADS_ENABLED = d.adsEnabled !== false;
    INTERSTITIAL_ENABLED = d.interstitialEnabled !== false;
    ADFREE_OPTION_ENABLED = d.adFreeOptionEnabled !== false;

    // DNS/Adblock hard lock toggle (default ON)
    DNS_HARD_LOCK_ENABLED = d.dnsHardLockEnabled !== false;

    updateAdFreeUI();
    setupAdblockGate(); // apply instantly
  });
}
// Anonymous auth (no email/pass on user page)
function ensureAnonymousAuth(){
  auth.onAuthStateChanged(async (u)=>{
    if(!u){
      try{ await auth.signInAnonymously(); }catch(e){ console.log(e); }
    }
  });
}

// 10 ads => 24h ad-free
async function watchOneAdForAdFree(){
  if(APP_LOCKED) return;

  // Already ad-free
  if(isAdFreeActive()){
    toast("‚úÖ Ad-Free already active");
    updateAdFreeUI();
    return;
  }

  // Master switches
  if(!ADS_ENABLED || !INTERSTITIAL_ENABLED || !ADFREE_OPTION_ENABLED){
    toast("‚ùå Reward ads are disabled");
    return;
  }

  // ‚è≥ Cooldown protection
  if(!canWatchRewardAd()){
    toast(`‚è≥ Please wait ${rewardWaitSeconds()}s`);
    return;
  }

  // ‚úÖ Show ad (manual click only)
  showInterstitialSafe();
  lastRewardAdTime = Date.now();

  // üìä Progress update
  let progress = adFreeProgress() + 1;
  localStorage.setItem(LS_ADFREE_PROGRESS, String(progress));

  if(progress >= REWARD_ADS_REQUIRED){
    const until = Date.now() + REWARD_ADFREE_HOURS * 60 * 60 * 1000;

    localStorage.setItem(LS_ADFREE_UNTIL, String(until));
    localStorage.setItem(LS_ADFREE_PROGRESS, "0");

    toast("üéâ 24h Ad-Free unlocked!");
  }else{
    toast(`‚úÖ Ad watched (${progress}/${REWARD_ADS_REQUIRED})`);
  }

  updateAdFreeUI();
}


/* ========= Helpers ========= */
function toast(msg){
  const t = $("toast");
  t.textContent = msg;
  t.classList.add("show");
  clearTimeout(window.__toastTimer);
  window.__toastTimer = setTimeout(()=>t.classList.remove("show"), 1600);
}
function canWatchRewardAd(){
  return Date.now() - lastRewardAdTime >= REWARD_COOLDOWN;
}

function rewardWaitSeconds(){
  const left = REWARD_COOLDOWN - (Date.now() - lastRewardAdTime);
  return Math.max(1, Math.ceil(left / 1000));
}
function setStatus(msg, ok=true){
  const el = $("statusLine");
  el.textContent = msg;
  el.style.color = ok ? "rgba(255,255,255,.85)" : "rgba(255,120,120,.95)";
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, (m)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function hashNames(arr){
  // quick stable hash
  let h=0;
  for(const s of arr){
    const str = String(s);
    for(let i=0;i<str.length;i++){
      h = ((h<<5)-h) + str.charCodeAt(i);
      h |= 0;
    }
  }
  return String(h);
}
async function copyText(text){
  if(navigator.clipboard && window.isSecureContext){
    try{ await navigator.clipboard.writeText(text); return true; }catch{ return false; }
  }else{
    const ta = document.createElement("textarea");
    ta.value=text; ta.style.position="fixed"; ta.style.left="-9999px"; ta.style.opacity="0";
    document.body.appendChild(ta);
    ta.select();
    try{
      const ok = document.execCommand("copy");
      document.body.removeChild(ta);
      return ok;
    }catch{
      document.body.removeChild(ta);
      return false;
    }
  }
}

/* ========= Local State (Smart Random B) ========= */
function keyCG(country, gender){ return `fng_state_${country}__${gender}`; }

function loadState(country, gender){
  try{
    const raw = localStorage.getItem(keyCG(country, gender));
    return raw ? JSON.parse(raw) : null;
  }catch{ return null; }
}
function saveState(country, gender, st){
  localStorage.setItem(keyCG(country, gender), JSON.stringify(st));
}
function resetState(country, gender){
  localStorage.removeItem(keyCG(country, gender));
}

/* ========= Cache ========= */
const cache = { countries: [], namesByCG: {} };
function cg(country, gender){ return `${country}|${gender}`; }

/* ========= Load countries ========= */
async function loadCountries(){
  const snap = await db.collection("names").get();
  const set = new Set();
  snap.forEach(doc=>{
    const d = doc.data() || {};
    if(d.country) set.add(String(d.country));
  });
  cache.countries = Array.from(set).sort((a,b)=>a.localeCompare(b));
  return cache.countries;
}

/* ========= Load names ========= */
async function loadNames(country, gender){
  const k = cg(country, gender);
  if(cache.namesByCG[k]) return cache.namesByCG[k];

  const snap = await db.collection("names")
    .where("country","==",country)
    .where("gender","==",gender)
    .get();

  let names = [];
  snap.forEach(doc=>{
    const d = doc.data() || {};
    if(Array.isArray(d.names)) names = names.concat(d.names);
  });

  names = names.map(n=>String(n).trim()).filter(Boolean);
  cache.namesByCG[k] = names;
  return names;
}

/* ========= Notice Listener ========= */
function startNoticeListener(){
  db.collection("settings").doc("notice").onSnapshot(doc=>{
    if(!doc.exists) return;
    const d = doc.data() || {};

    // Notice controls
    const noticeActive = !!d.noticeActive;
    const text = (d.noticeText || "").trim();
    const noticeShowTelegramLink = d.noticeShowTelegramLink !== false;

    // Telegram CTA controls
    const tgEnabled = d.telegramCtaEnabled !== false; // default ON
    const tg = (d.tgLink || "").trim();
    const tgText = (d.telegramCtaText || "Telegram").trim();

    // --- Telegram CTA (top button) ---
    const pill = $("tgPill");
    if(tgEnabled && tg){
      pill.style.display = "inline-flex";
      pill.href = tg;
      pill.querySelector("span").textContent = tgText;
    }else{
      pill.style.display = "none";
    }

    // --- Notice Bar ---
    const bar = $("noticeBar");
    if(noticeActive && text){
      bar.style.display = "block";

      if(noticeShowTelegramLink && tg){
        bar.innerHTML = `üì¢ ${escapeHtml(text)} ‚Äî <a href="${tg}" target="_blank" rel="noopener">Join Telegram</a>`;
      }else{
        bar.innerHTML = `üì¢ ${escapeHtml(text)}`;
      }
    }else{
      bar.style.display = "none";
    }
  });
}

/* ========= Generate Wrapper (Ads + Gate) ========= */
async function generate(){
  if(APP_LOCKED){
    lockApp();
    return;
  }

  // Master switch: admin can disable all ads anytime
  if(!ADS_ENABLED){
    return generateCore();
  }

  // If user has 24h ad-free active => no ads
  if(isAdFreeActive()){
    return generateCore();
  }

  // Normal mode: every 5 generate => show interstitial (cap 8/day)
  const cur = getCounts();
  const nextGen = cur.gen + 1;
  setGen(nextGen);

  // show ad on interval (and only if interstitial enabled)
  if(INTERSTITIAL_ENABLED && (nextGen % GEN_INTERVAL === 0) && cur.ads < DAILY_AD_CAP){
    // small UX delay feels like "processing"
    setTimeout(()=>{ try{ showInterstitialSafe(); }catch{} }, 400);
    setAds(cur.ads + 1);
  }

  // server-side minimal sync (non-blocking)
  syncUserCounters(nextGen, parseInt(localStorage.getItem(LS_ADS)||"0",10)).catch(()=>{});

  return generateCore();
}

/* ========= Generate (FIXED) ========= */
async function generateCore(){
  const country = $("countrySelect").value;
  const gender = $("genderSelect").value;

  if(!country){
    setStatus("Please select a country.", false);
    toast("Select country first ‚ö†Ô∏è");
    return;
  }

  $("genBtn").disabled = true;

  try{
    const names = await loadNames(country, gender);

    if(!names.length){
      $("nameBox").textContent = "No names found";
      setStatus(`No names for ${country} (${gender}). Add from admin.`, false);
      return;
    }

    const h = hashNames(names);
    let st = loadState(country, gender);

    // New state if none or list changed
    if(!st || st.hash !== h || !Array.isArray(st.order) || st.total !== names.length){
      const order = Array.from({length:names.length}, (_,i)=>i);
      shuffle(order);
      st = { order, pos: 0, hash: h, total: names.length };
      saveState(country, gender, st);
    }

    // If cycle finished, reshuffle and SAVE immediately
    if(st.pos >= st.order.length){
      const order = Array.from({length:names.length}, (_,i)=>i);
      shuffle(order);
      st = { order, pos: 0, hash: h, total: names.length };
      saveState(country, gender, st);
    }

    const idx = st.order[st.pos];
    st.pos += 1;
    saveState(country, gender, st);

    const picked = names[idx] || "‚Äî";
    $("nameBox").textContent = picked;

    const left = st.order.length - st.pos;
    setStatus(`Generated: ${country} (${gender}) ‚Ä¢ Remaining (no-repeat): ${left}/${st.order.length}`, true);
  }catch(e){
    setStatus("Error: " + (e.message || e), false);
  }finally{
    $("genBtn").disabled = false;
  }
}

/* ========= Init ========= */
async function init(){
  $("nameBox").textContent = "Loading‚Ä¶";
  setStatus("Loading countries‚Ä¶", true);

  try{
    ensureAnonymousAuth();
    await setupAdblockGate();

    // Re-check every few seconds (covers recent/app resume cases)
    setInterval(()=>{ setupAdblockGate(); }, 6000);

    // Re-check when app/tab comes back to foreground
    document.addEventListener("visibilitychange", ()=>{
      if(!document.hidden) setupAdblockGate();
    });
    window.addEventListener("focus", ()=>setupAdblockGate());
startNoticeListener();
    startAdsSettingsListener();
    updateAdFreeUI();

    const countries = await loadCountries();
    const sel = $("countrySelect");
    sel.innerHTML = "";

    if(!countries.length){
      sel.innerHTML = `<option value="">No countries yet</option>`;
      $("nameBox").textContent = "No data";
      setStatus("No countries found. Add from admin panel.", false);
      return;
    }

    countries.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });

    $("nameBox").textContent = "Tap Generate";
    setStatus("Ready ‚úÖ Select country & gender.", true);
  }catch(e){
    $("countrySelect").innerHTML = `<option value="">Error</option>`;
    $("nameBox").textContent = "Error";
    setStatus("Failed to load data: " + (e.message || e), false);
  }
}

/* ========= Events ========= */
$("genBtn").addEventListener("click", generate);
$("adFreeBtn").addEventListener("click", watchOneAdForAdFree);

$("nameBox").addEventListener("click", async ()=>{
  const txt = $("nameBox").textContent.trim();
  if(!txt || ["Tap Generate","Loading‚Ä¶","No data","No names found","Error"].includes(txt)) return;

  const ok = await copyText(txt);
  toast(ok ? "Copied ‚úÖ" : "Copy failed ‚ùå");
});

$("resetBtn").addEventListener("click", ()=>{
  const country = $("countrySelect").value;
  const gender = $("genderSelect").value;
  if(!country) return;

  resetState(country, gender);
  toast("Reset done ‚úÖ");
  setStatus(`Reset: ${country} (${gender}) ‚Äî next generate will reshuffle.`, true);
});

$("refreshBtn").addEventListener("click", async ()=>{
  cache.countries = [];
  cache.namesByCG = {};
  $("countrySelect").innerHTML = `<option value="">Loading...</option>`;
  $("nameBox").textContent = "Loading‚Ä¶";
  await init();
});

/* Start */
init();
</script>
</body>
</html>